<!DOCTYPE html>
<html lang="fr">
  <head>
    <title>Groupomania</title>

    <meta charset="utf-8" />

    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
    <meta name="description" content="Réseau social d'entreprise" />
    <!-- <link rel="icon" href="<%= BASE_URL %>favicon.ico" /> -->

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link href="../css/style.css" rel="stylesheet" />
    <link href="../css/login.css" rel="stylesheet" />
    <link href="../css/posts.css" rel="stylesheet" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body>
    <header>
      <div class="limitedWidthBlockContainer informations">
        <div class="limitedWidthBlock">
          <ul>
            <li>
              <img
                src="../images/icons/phone.svg"
                alt="logo de téléphone"
                class="informations__phone"
              />012345678
            </li>
          </ul>
        </div>
      </div>
      <div class="limitedWidthBlockContainer menu">
        <div class="limitedWidthBlock">
          <a href="./index.html">
            <img
              class="logo"
              src="../images/logo.png"
              alt="Logo de l'entreprise"
            />
          </a>
          <nav>
            <ul>
              <a href="./index.html"><li>accueil</li></a>
            </ul>
          </nav>
        </div>
      </div>
    <!-- <main>** -->
    <main id="app">
      <h1>les posts des salariés de Groupomania</h1>
      <h3> Bonjour {{nom}}</h3>
      <div>
        <!-- Bouton pour créer un post -->
        <div class="cart__order__form__submit">
                
             
          <button @click="createPost()">    
                        
            Créer un post
                       
          </button>
        </div>
      </div>

      <div>
        <div v-if="errored">
          <p>Serveur indisponible</p>
        </div>

        <div v-else>
          <h4 v-if="loading">Loading... dernières nouvelles</h4>
          <div class="postsList">
            <div v-for="itemPost in posts.posts" :key="itemPost.postId" class="post">

              <article class="postArticle">       
       
                <div class="postItem">
                  <div class="postHeader">
                    
                    <div class="postDate"> <p>Date: {{itemPost.postDate}}</p>
                            </div>
                    <div class="postOwner">
                      <p>par: {{itemPost.pseudo}}</p>
                    </div>
                  </div>
                  <div class="postInfos">
                    <div class="postText"><p> post n° {{itemPost.postId}} : {{itemPost.post}}</p></div>
                      <button @click="displayComments(itemPost.postId)">

                        Afficher les commentaires
                      
                       
                      </button>

                      <div >
                        <div v-for="itemComment in comments.comment" :key="itemComment.commentId" class="comment">      
                          <div v-if="itemPost.postId==itemComment.postId">
                            <p> Date:  {{itemComment.commentDate}} par {{itemComment.pseudo}} {{itemComment.comment}}</p>
                          </div>
                        </div>
                      </div>
                  </div>
                </div>
              </article>
            </div>
          </div>
        </div>
      </div>
    </main>


      <!-- Footer -->

    <footer>
      <div class="limitedWidthBlockContainer footerMain">
        <div class="limitedWidthBlock">
          <div>
            <img
              class="logo"
              src="../images/logo.png"
              alt="Logo de l'entreprise"
            />
          </div>
          <div>
            <!--<p>{{adresse}} <br />{{ville}}</p>-->
          </div>
        </div>
      </div>
    </footer>
    <script src="https://unpkg.com/vue@next"></script>



    <script>
          // vuejs3
      const RootComponent = {
        //les data
        data() {
          return {
            nom: "",
            posts: [],
            comments: [],

            loading: false,
            errored: false,

            loadingComments: false,
            erroredComments: false,
          };
        }, // fin des data

        //----------------------------------------------------------------------------

        //Affichage des posts
        created() {
          // Creating loader
          this.loading = true;

          // Lecture du local storage pour récupérer les infos du user
          let userInLocalStorage = JSON.parse(localStorage.getItem("user")); //objet "user" du local storage
          const userToken = userInLocalStorage.token; // le token

          const userNom=userInLocalStorage.pseudo; // le nom affiché en entete de feuille
          this.nom=userNom;

          const bearerToken = "Bearer " + userToken;
          const postUrl = "http://localhost:3000/api/post/"; //Url pour récupérer les posts
          fetch(postUrl, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: bearerToken,
            },
          })
            .then((response) => response.json()) //reponse du fetch
            .catch((error) => {
              console.log("Fetch error: ", error);
              this.errored = true;
            })
            .then((response) => {
              this.posts = response; //this permet d'acceder aux données de l'application
            })
            .catch((error) => {
              console.log("Response error: ", error);
              this.errored = true;
            });
        }, // Fin methode created

        //------------------------------------------------------------------------------------

        methods: {
          //Affichage des commentaires du post
          displayComments(postId) {
            console.log(postId);
            // Creating loader
            this.loadingComments = true;

            // Lecture du local storage pour récupérer le token  du user
            let userInLocalStorage = JSON.parse(localStorage.getItem("user")); //objet "user" du local storage
            const userToken = userInLocalStorage.token; // le token

            const bearerToken = "Bearer " + userToken;

            //Url des commentaires du post
            const commentsUrl =
              "http://localhost:3000/api/post/" + postId + "/comment";

            fetch(commentsUrl, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: bearerToken,
              },
            })
              .then((response) => response.json()) //reponse du fetch
              .catch((error) => {
                console.log("Fetch error: ", error);
                this.erroredComments = true;
              })
              .then((response) => {
                this.comments = response; //this permet d'acceder aux données de l'application
              })
              .catch((error) => {
                console.log("Response error: ", error);
                this.erroredComments = true;
              });
          }, //Fin displayComments
        }, // Fin des methodes
      }; // Fin RootComponent

      const app = Vue.createApp(RootComponent).mount("#app");
      console.log(app);
    </script>
  </body>
</html>
