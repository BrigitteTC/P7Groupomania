<!DOCTYPE html>
<html lang="fr">
  <head>
    <title>Groupomania</title>

    <meta charset="utf-8" />
    <meta name="description" content="Réseau social d'entreprise" />
    <!-- <link rel="icon" href="<%= BASE_URL %>favicon.ico" /> -->

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link href="../css/style.css" rel="stylesheet" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body>
    <div id="app">
      <header>
        <div class="limitedWidthBlockContainer informations">
          <div class="limitedWidthBlock">
            <ul>
              <li>
                <img
                  src="../images/icons/phone.svg"
                  alt="logo de téléphone"
                  class="informations__phone"
                />{{tel}}
              </li>
            </ul>
          </div>
        </div>
        <div class="limitedWidthBlockContainer menu">
          <div class="limitedWidthBlock">
            <a href="./index.html">
              <img
                class="logo"
                src="../images/logo.png"
                alt="Logo de l'entreprise"
              />
            </a>
            <nav>
              <ul>
                <li><a href="./signup.html">signup</a></li>
                <li><a href="./login.html">login</a></li>
              </ul>
            </nav>
          </div>
        </div>
        <img class="banniere" src="../images/banniere.png" alt="Baniere" />
      </header>

      <main class="limitedWidthBlockContainer">
        <div class="limitedWidthBlock">
          <div class="titles">
            <h1>{{message}}</h1>
            <h2>Voici un espace d'échange entre les salariés</h2>
            <h2>Pour tout ce que vous voulez partager sur l'entreprise</h2>
            <h2>Tout est permis, mais avec modération.</h2>
          </div>
        </div>
      </main>

      <footer>
        <div class="limitedWidthBlockContainer footerMain">
          <div class="limitedWidthBlock">
            <div>
              <img
                class="logo"
                src="../images/logo.png"
                alt="Logo de l'entreprise"
              />
            </div>
            <div>
              <p>{{adresse}} <br />{{ville}}</p>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <script src="https://unpkg.com/vue@next"></script>

    <script>
      //----------------------------------------------------------------------------
      // vuejs3
      //----------------------------------------------------------------------------

      const RootComponent = {
        //les data
        data() {
          return {
            // infos de l'entreprise
            adresse: "rue de l'horizon",
            ville: "19300 labas sur Correze",
            tel: "01 23 45 67 89",
            //nom et infos de l'utilisateur connecté
            connectedName: "",
            connectedUserId: "",
            connectedModerator: false,

            //tableau des posts et des commentaires
            posts: [],
            comments: [],

            // etats chargement et erreurs
            loading: false,
            errored: false,

            loadingComments: false,
            erroredComments: false,

            // champs du formulaire pour creéation ou modification posts et comments
            createPostForm: false, //sera true pour crer un post
            modifyPostForm: "", //sera egal au num du post à modifier pour modifier un post
            newPost: "",

            createCommentForm: "", //sera egal au num du post sue lequel on veut creer un commentaire
            modifyCommentForm: "", //sera egal au num du commentaire à modifier
            newComment: "",

            // Utilisateurs
            modifyProfilForm: false, // sera true pour modifier le profil de l'utilisateur
            newEmail: "", // nouvel email
            newPasswd: "", //      newPasswd = nouveau passwd
            newPseudo: "", //      newPseudo = nouveau pseudo

            valueToModify: "", // Valeur de profil à modifier
            newValue: "", // Nouvelle valeur du champ modifié

            askValue: false, // sera mis à true pour ouvrir le champ de saisie pour modif profil
            askEmail: false, // sera mis à true pour modifier le champ
            askPseudo: false, // sera mis à true pour modifier le champ
            askpasswd: false, // sera mis à true pour modifier le champ

            deleteValue: false, //sera mis a true pour supprimer un compte
          };
        }, // fin des data

        //----------------------------------------------------------------------------
        //Initialisation de la page
        //-----------------------------------------------------------------------------
        beforeCreate() {
          //loader
          this.loading = true;
        },

        //----------------------------------------------------------------------------
        // Suite initialisation
        // Affichage de la page au chargement
        // et appel de l'API pour afficher les posts.
        // this permet d'acceder aux données de l'application
        //----------------------------------------------------------------------------
        created() {
          // Lecture du local storage pour récupérer les infos du user
          // Rien ne sera affiché si aucun user n'est connecté = local storage vide
          if ("user" in localStorage) {
            const userInLocalStorage = JSON.parse(localStorage.getItem("user")); //objet "user" du local storage

            const userToken = userInLocalStorage.token; // le token

            // Les infos de l'utilisateur connecté

            this.connectedName = userInLocalStorage.pseudo; // le nom affiché en entete de feuille
            this.connectedUserId = userInLocalStorage.userId;
            this.connectedModerator = userInLocalStorage.moderator;

            console.log(
              "user connecte ;" +
                this.connectedName +
                this.connectedUserId +
                this.connectedModerator
            );

            const bearerToken = "Bearer " + userToken;

            const postUrl = "http://localhost:3000/api/post/"; //Url pour récupérer les posts
            fetch(postUrl, {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: bearerToken,
              },
            })
              .then((response) => response.json()) //reponse du fetch
              .catch((error) => {
                console.log("Fetch error: ", error);
                windows.alert(error);
                this.errored = true;
              })
              .then((data) => {
                this.posts = data; //Data renvoyées du serveur
              })
              .catch((error) => {
                console.log("Response error: ", error);
                this.errored = true;
              });
          } // fin test if user in local storage
        }, // Fin created

        //------------------------------------------------------------------------------------
        // Page complètement chargée
        //------------------------------------------------------------------------------------
        mounted() {
          // Load terminé
          this.loading = false;
        },

        //------------------------------------------------------------------------------------
        // Les methodes
        //------------------------------------------------------------------------------------
        methods: {}, // Fin des methodes
      }; // Fin RootComponent

      const app = Vue.createApp(RootComponent).mount("#app");
      console.log(app);
    </script>
  </body>
</html>
